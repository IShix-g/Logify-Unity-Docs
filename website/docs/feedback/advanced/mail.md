---
sidebar_position: 2
---

# 📨 メール連携

PHPの `mail()` 関数を使用してフィードバックを送信します。
メール送信は、サーバーの構成やドメインの信頼性によって **「送信には成功しているが、どこにも届かない（あるいは迷惑メールに入る）」** という現象が頻発します。以下の手順で慎重にテストを行ってください。

## 📋 必要環境・準備

* **[PHPサーバーセットアップ](server-setup.md)** が完了されていること
* **サーバーの送信許可**: お使いのレンタルサーバーやVPSで、PHPからのメール送信（sendmail等）が許可されている必要があります
* **SSL環境**: 必須ではありませんが、セキュリティと信頼性の観点から推奨します

---

## 🛠️ セットアップ手順

### Step 1: 最小構成でのテスト

まずは、`setup.php` によって自動生成された `from` アドレスを**変更せずに**、受信したいアドレス（`to`）だけを設定してテストしてください。

1. `config.php` の `email > enabled` を `true` にします。
2. `to` に自分のメールアドレスを入力します。
3. `from` は自動入力されたドメイン（例: `noreply@example.com`）のままにします。

### Step 2: カスタムドメインの設定（届かない場合）

Step 1 で届かない場合、`from` アドレスをサーバーのドメインに合わせた実在する（または推奨される）形式に変更します。

```php
// ...
'email' => [
    'enabled' => true,
    'to'      => 'your-name@gmail.com', // 受信先
    'from'    => 'noreply@example.com', // サーバーのドメインに合わせる
],
// ...
```

:::warning Fromアドレスの注意点
`from` に **GmailやYahooメールのアドレスを直接指定しないでください。**
送信元ドメインと実際のサーバーが一致しないため、DMARC/SPF認証に失敗し、ほぼ確実にブロックされます。必ず「サーバーがホストしているドメイン」を使用してください。
:::

---

## 🔍 トラブルシューティング（届かない時は？）

メールが届かない場合、以下の要因が考えられます。

* **迷惑メールフォルダを確認**:
  SPFレコードが設定されていない場合、高い確率で迷惑メールに分類されます。
* **サーバーのログを確認**:
  PHP側で送信エラーが発生した場合は、`data/debug_???.log` にエラー内容が記録されます。
* **Gmail等のホワイトリスト**:
  特定のドメインからのメールを「安全なメール」として受信許可設定を試してください。
* **PHP `mail()` の制限**:
  一部の安価なレンタルサーバーでは、スパム対策として `mail()` 関数の利用を禁止している場合があります。

---

## 🧪 動作確認 {#testing}

設定が完了したら、実際にフィードバックが届くかテストを行います。

1. **[動作確認の手順](https://www.google.com/search?q=../../getting-started/quick-start.md%23testing)** に沿ってアプリを実行します。
2. ゲーム内の **Custom > Feedback** タブを開き、メッセージを入力して送信します。
3. 設定した `to` のメールボックスを確認してください。

<img src={require('../../feature-guide/img/feedback.jpg').default} width="550" className="margin-bottom--md" />

### 📬 受信例

<img src={require('./img/mail.jpg').default} width="550" />